input {
  tcp {
    port => 50000
    codec => "json_lines"
  }
}

filter {
  date {
    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }
  
  mutate {
    convert => { "event_type" => "string" }  # ⚠️ string 변환 필수
  }

  if [device] in ["Elevator", "Escalator", "Screen Door"] {
    mutate { add_field => { "team" => "electrical_team" } }
  } else if [device] in ["Fire Alarm", "Sprinkler", "Fire Door"] {
    mutate { add_field => { "team" => "fire_safety_team" } }
  } else if [device] in ["CCTV", "Monitor", "Boarding Gate"] {
    mutate { add_field => { "team" => "communication_team" } }
  }

  # ⭐️ 문법 오류를 수정한 translate 필터
  translate {
    field => "event_type"
    destination => "event_desc_kr"
    dictionary => [
      "101", "영상 신호 손실",
      "102", "카메라 영상 흐림",
      "103", "화면 출력 오류",
      "104", "게이트 응답 없음",
      "105", "모터 과열",
      "106", "해상도 불일치",
      "201", "화재 감지",
      "202", "배터리 전압 낮음",
      "203", "누수 감지",
      "204", "방화문 닫힘 불량",
      "205", "테스트 모드 작동 중",
      "301", "비상 정지 작동",
      "302", "작동 중 흔들림 감지",
      "303", "스크린도어 개방 실패",
      "304", "센서 오류",
      "305", "정기 점검 중"
    ]
    fallback => "알 수 없는 이벤트"
  }

  translate {
    field => "status"
    destination => "status_kr"
    dictionary => [
      "Critical", "심각",
      "Warning",  "경고",
      "Normal",   "정상",
      "Info",     "정보"
    ]
  }

  translate {
    field => "team"
    destination => "team_kr"
    dictionary => [
      "electrical_team",    "전기팀",
      "fire_safety_team",   "소방팀",
      "communication_team", "통신팀"
    ]
  }

  if [status] == "Critical" {
    mutate { add_tag => ["high_risk"] }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "changeme"
    index => "subway-facility-logs-%{+YYYY.MM.dd}"
  }
  stdout {
    codec => rubydebug
  }
}
